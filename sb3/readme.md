# 模型
## 基础环境
basic_env.xml：提取各环境相通性，每个实验的xml都会用到  
包括一些可视化、环境美化、接触使能  

## 机器人
robot_stick.xml：用于恒力接触实验，连杆、力传感器共长0.169m  
robot_link.xml：用于开关抽屉、门实验，连杆、力传感器共长0.169m  
两个文件的区别在于dummy body不一样，第一个是球，第二个是卡子  
末端有三个位置约束:stick位置与长度,ee位置，dummy body位置，因此一共4个数，记得一次全部修改  

## 桌子
jk5_table_v1为原版文件  
jk5_table_v2为当前文件，提取机器人部分，优化xml结构  

## 门
jk5_door_v1为松耦合文件，只能关门  
jk5_opendoor_v1为紧耦合文件，能开门与关门  
两者均被废弃，可以用，但是没用来训练，因为实际机器人没法那么摆  

## 储物柜
根据cabinet设计的原尺寸箱子。  
jk5_cabinet_v1用于恒力接触任务，更近更低
jk5_cabinet_v2用于开关抽屉、门实验 ，更高更远  

# 阻抗控制
## 机器人
### 运动学模型
针对不同任务，kdl model有不同的连杆长度  
现在有五个坐标系，以及之间的转换  
世界坐标系：世界的中心的位姿  
机器人基坐标系：机器人的baselink的位姿  
机器人末端坐标系：不带力传感器、杆的机器人末端，标记为re  
机器人连杆坐标系：杆的末端的位姿，标记为ee，当前安装有connect force sensor，当前雅克比基于该坐标系，运动学通过此定义  
机器人工具坐标系：末端用于碰撞的dummy body坐标系  

## 轨迹规划
把手是突出的，记得计算把手的位置

## 误差计算
### 位置误差
### 姿态误差
#### 欧拉角误差
#### 基于四元数误差
误差趋于0001（实数在最后）则说明很好，说明转动角度为0  

## 控制器
控制都是结合了机器人动力学，具体在于q两点的计算不同  
计算力矩控制器，算得是q两点+d q一点+p q  
阻抗控制器，算得是用阻抗方程结算出来的q两点+kd q一点+kp q+外力  
上面的没有外力，下面的有外力，似乎是唯一区别  

阻抗控制中的mbk，结合可以得到计算力矩控制器中kpkd的相同形式，但是多考虑了接触力，改变了稳定点  
所以阻抗控制没有pd参数，导纳控制有pd参数  

### 计算力矩控制器
计算力矩控制中pd参数引入的好处：实现轨迹跟踪  
用到了外力

### 阻抗控制器
#### 位置阻抗
e = xc - xd  
M ddot(e) + B dot(e) + K ddot(e) = F  
各方向阻抗特性解耦，形变量与弹力一致  
#### 姿态阻抗
### 导纳控制器

# 强化学习变阻抗控制部分
## 变阻抗控制
阻尼比\epsilon=1/sqrt(2)，无阻尼震荡频率sqrt(10)  
0<\epsilon<1时，系统的输出存在超调量，且\epsilon决定了超调量的大小  
超调量只与\epsilon有关，\epsilon和\omega_{n}共同决定了系统的响应速度。  

\varepsilon越大超调量越小，响应速度越慢。  
\omega_{n}越大系统响应越快。  

## 强化学习
Jk5StickStiffnessEnv单独也为gym格式,循环为状态s_t  
env在其基础上封装，仍然是gym格式，循环为观测o_t  
env为Jk5StickStiffnessEnv与gym的中间件,o_t由s_t组成

# 任务
优化目标的确定
## 指标
位置误差
姿态误差：  
xquat描述了末端姿态相对于基坐标系的四元数旋转，确实没问题，就是xyzw看起来挺迷糊
orientation是最直观的误差，在哪个方向上加力就产生哪个方向的偏差  

## 桌面
恒力接触
### 受力分析
机器人作为受力者，以机器人阻抗特性为出发点分析，力一定与位姿、速度偏差成正比  
不仅包括z方向上的偏差，同样也包括xy平面上的偏差，这些偏差也蛮大的  

以下为机器人施加给桌子的力  
感觉不止包括摩擦力，还有由于末端插入桌子，使得平面上也有支持力    
- x：时变量，前半段与后半段的大小、方向不一样。  
前半段机器人往圆弧内移动，受到x负方向力  
后半段机器人往圆弧外移动，受到x正方向力  
分解点在y=0左右
- y：稳定后保持不变，与运动方向相反，即y负方向
- z：稳定后保持不变

y和z的合力即为仿真中蓝色反方向
- 旋转
加大扭转摩擦，z负方向出现扭矩  
机器人绕z负方向旋转，末端关节因此绕z正方向旋转，从而保证整体姿态不变  
控制不足情况下，出现与末端转动相反的力矩，即负方向力矩

## 抽屉
优化期望轨迹（期望轨迹有向下趋势，或让桌子有点倾角）、接触力（正比于frictionloss）
优化打开距离，关闭距离
刚度也需要优化（不能太小），不然就是那种蹦蹦跳跳的

# 问题
为啥要执着于一种相对位置，为啥要执着于一种末端  
多个环境，多种末端连接器
紧耦合：没法让他利用惯性移动

尽量
做仿真吧，先别管实物结构

第一个任务做实物，余下的做仿真算了，那两个任务紧耦合很难做
第一个有末端连杆的实物
第二三个还要设计紧耦合机制：钩子？自己画一个钩子，取消约束
既然只做仿真，那就随便改，只要验证有效性，改这个重新训练难度不会特别大
多个xml就多个吧，自己注意一点，